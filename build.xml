<?xml version="1.0" encoding="UTF-8"?>
<project name="gp-unit" default="package">
    <property name="gp.unit.dir" location="./" />

    <!-- in order to compile gp-unit, and to run gp-unit tests, must download the client library -->
    <property name="gp.host" value="gpdev.broadinstitute.org" />
    <property name="gp.url" value="http://${gp.host}" />
    <property name="local.dir" location="${gp.unit.dir}/tmp/${gp.host}" />
    <property name="client.lib.dir" location="${local.dir}/client" />
    <!-- if the client.dir already exists, skip the rest -->
    <available property="gp-client-lib-exists" file="${client.lib.dir}/GenePattern.jar" />

    <!-- build gp-unit.jar -->
    <property name="gp.full.jar" location="/Applications/GenePatternServer/Tomcat/webapps/gp/WEB-INF/lib/gp-full.jar" />

    <path id="gp.client.classpath">
        <pathelement location="${client.lib.dir}/GenePattern.jar" />
        <fileset dir="${client.lib.dir}/lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="gp.unit.classpath">
        <fileset dir="${gp.unit.dir}/lib">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="${gp.unit.dir}/classes"/>
        <!-- pathelement location="${gp.full.jar}" / -->
        <path refid="gp.client.classpath" />
    </path>

    <target name="init">
        <tstamp />
        <mkdir dir="${gp.unit.dir}/classes" />
        <mkdir dir="${gp.unit.dir}/dist" />
        <mkdir dir="${client.lib.dir}" />
    </target>


    <target name="gp-client-lib" depends="init" unless="gp-client-lib-exists">
        <description>If necessary, download the Java Programming Library from the server, and unzip into a local directory</description>

        <property name="http.url" value="${gp.url}/gp/downloads/GenePattern.zip" />
        <get src="${http.url}" dest="${local.dir}/GenePattern.zip" usetimestamp="true" />
        <unzip src="${local.dir}/GenePattern.zip" dest="${client.lib.dir}" overwrite="true" />
    </target>

    <target name="compile" depends="init, gp-client-lib">
        <property name="java.target" value="1.5" />
        <javac debug="true" 
            defaultexcludes="true" 
            deprecation="true" 
            destdir="${gp.unit.dir}/classes" 
            optimize="false" 
            proceed="false" 
            srcdir="${gp.unit.dir}/src/main/java" 
            target="${java.target}" 
            source="${java.target}" 
            classpathref="gp.unit.classpath" >
        </javac>
    </target>

    <target name="package" depends="compile">
        <jar basedir="${gp.unit.dir}/classes" jarfile="${gp.unit.dir}/dist/gp-unit.jar" />
    </target>

    <target name="clean">
        <delete dir="${gp.annotations.dir}/classes" />
        <delete dir="${gp.annotations.dir}/dist" />
    </target>
    <!-- END build gp-unit.jar -->
    
    <!-- run gp-unit test -->    
    <property name="test.file" location="./tests/protocols/01_Run/step1/test.yaml" />
    <macrodef name="run-test">
        <attribute name="test.file" />
        <sequential>
            <echo>Running test from @{test.file}</echo>
            <java classname="org.genepattern.gpunit.RunTest" fork="true"
                classpathref="gp.unit.classpath" >
                <arg value="@{test.file}" />
            </java> 
        </sequential>
    </macrodef>

    <target name="gp-unit-test" depends="package">
        <run-test test.file="${test.file}" />
    </target>
</project>
