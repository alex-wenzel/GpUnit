<?xml version="1.0" encoding="UTF-8"?>
<project name="build-gp-unit" default="package">
    <property name="gp.unit.dir" location="./" />

    <!-- in order to compile gp-unit, and to run gp-unit tests, must download the client library -->
    <property name="gp.host" value="gpdev.broadinstitute.org" />
    <property name="gp.url" value="http://${gp.host}" />
    <property name="local.dir" location="${gp.unit.dir}/tmp/${gp.host}" />
    <property name="client.lib.dir" location="${local.dir}/client" />
    <!-- if the client.dir already exists, skip the rest -->
    <available property="gp-client-lib-exists" file="${client.lib.dir}/GenePattern.jar" />

    <path id="gp.client.classpath">
        <pathelement location="${client.lib.dir}/GenePattern.jar" />
        <fileset dir="${client.lib.dir}/lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="gp.unit.classpath">
        <fileset dir="${gp.unit.dir}/lib">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="${gp.unit.dir}/classes"/>
        <path refid="gp.client.classpath" />
    </path>

    <target name="init">
        <tstamp />
        <mkdir dir="${gp.unit.dir}/classes" />
        <mkdir dir="${gp.unit.dir}/dist" />
    </target>

    <target name="gp-client-lib" depends="init" unless="gp-client-lib-exists">
        <description>If necessary, download the Java Programming Library from the server, and unzip into a local directory</description>

        <mkdir dir="${client.lib.dir}" />
        <get src="${gp.url}/gp/downloads/GenePattern.zip" 
            dest="${local.dir}/GenePattern.zip" usetimestamp="true" />
        <unzip src="${local.dir}/GenePattern.zip" dest="${client.lib.dir}" overwrite="true" />
    </target>

    <target name="compile" depends="init, gp-client-lib">
        <property name="java.target" value="1.5" />
        <javac debug="true"
            srcdir="${gp.unit.dir}/src/main/java" 
            destdir="${gp.unit.dir}/classes" 
            includeantruntime="false"
            target="${java.target}" 
            source="${java.target}" 
            classpathref="gp.unit.classpath" >
        </javac>
    </target>

    <target name="package" depends="compile">
        <jar basedir="${gp.unit.dir}/classes" jarfile="${gp.unit.dir}/dist/gp-unit.jar" />
    </target>

    <target name="clean">
        <delete dir="${gp.unit.dir}/classes" />
        <delete dir="${gp.unit.dir}/dist" />
    </target>

</project>
